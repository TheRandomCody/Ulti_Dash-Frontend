<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ulti-Bot</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* A little extra style for a nice background */
        body {
            background-color: #1a202c;
            color: #e2e8f0;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen font-sans">

    <!-- TOP BAR -->
    <header class="bg-gray-900 shadow-lg">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">Ulti-Bot</h1>
            <!-- Login/Logout Button Area -->
            <div id="auth-container">
                <!-- This will be dynamically filled by JavaScript -->
                <div class="h-10 w-48 bg-gray-700 rounded-lg animate-pulse"></div>
            </div>
        </nav>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow container mx-auto px-6 flex flex-col">
        <div id="main-content" class="w-full max-w-5xl mx-auto flex-grow flex flex-col">
            <!-- Loading Skeleton -->
            <div class="flex-grow flex flex-col md:flex-row items-stretch justify-center space-y-6 md:space-y-0 md:space-x-6 py-8">
                 <div class="flex-1 bg-gray-700 rounded-lg animate-pulse"></div>
                 <div class="flex-1 bg-gray-700 rounded-lg animate-pulse"></div>
                 <div class="flex-1 bg-gray-700 rounded-lg animate-pulse"></div>
            </div>
        </div>
    </main>

    <!-- BOTTOM BAR -->
    <footer class="bg-gray-900 text-gray-400 py-4">
        <div class="container mx-auto px-6 text-center">
            <p>Ulti-Bot &copy; 2025</p>
        </div>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // Define the base URL for your production backend API
        // *** FIX: Replace this placeholder with your ACTUAL Render backend URL ***
        // The "Failed to fetch" error happens because this URL is not correct.
        // Find your backend service URL in the Render dashboard (e.g., 'https://your-api-name.onrender.com').
        const API_BASE_URL = 'https://REPLACE-WITH-YOUR-RENDER-BACKEND-URL.onrender.com'; 

        // Get references to the HTML elements we'll be manipulating
        const authContainer = document.getElementById('auth-container');
        const mainContent = document.getElementById('main-content');

        // This function runs when the page loads
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Check if the user is logged in by calling our backend's /me endpoint
                // 'credentials: include' is crucial for sending the session cookie
                const response = await fetch(`${API_BASE_URL}/api/users/me`, { credentials: 'include' });
                
                if (response.ok) {
                    const user = await response.json();
                    renderLoggedInState(user);
                } else {
                    renderLoggedOutState();
                }
            } catch (error) {
                console.error('Error checking authentication status:', error);
                renderErrorState();
            }
        });

        // --- RENDER FUNCTIONS ---

        function renderLoggedInState(user) {
            authContainer.innerHTML = `
                <div class="flex items-center space-x-4">
                    <span class="text-white hidden sm:inline">Welcome, ${user.username}</span>
                    <a href="${API_BASE_URL}/api/auth/logout" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                        Logout
                    </a>
                </div>
            `;

            if (user.verificationStatus === 0) {
                renderVerificationNeededState();
            } else {
                renderMainButtons();
            }
        }

        function renderLoggedOutState() {
            authContainer.innerHTML = `
                <a href="${API_BASE_URL}/api/auth/discord/login" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    Login with Discord
                </a>
            `;
            renderMainButtons(true); // Pass true to indicate they should be login links
        }

        function renderVerificationNeededState() {
            mainContent.innerHTML = `
                <div class="flex-grow flex flex-col justify-center text-center">
                    <div>
                        <h2 class="text-4xl font-bold mb-4 text-white">Verification Required</h2>
                        <p class="text-xl mb-8 text-gray-300">To access the Ulti-Bot network, you must first verify your identity. This is a one-time process to ensure the safety and security of our communities.</p>
                        <button id="verify-button" class="bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg text-lg transition duration-300 ease-in-out transform hover:scale-105 py-6 text-2xl w-full max-w-md mx-auto">
                            Verify with Stripe
                        </button>
                        <p class="text-sm mt-4 text-gray-500">(This will redirect to Stripe Identity. We do not store your personal documents.)</p>
                    </div>
                </div>
            `;
            // Add an event listener to the new button
            document.getElementById('verify-button').addEventListener('click', handleVerification);
        }

        function renderMainButtons(isLogin = false) {
            const serverSearchUrl = isLogin ? `${API_BASE_URL}/api/auth/discord/login` : '/server-search.html';
            const serverManagementUrl = isLogin ? `${API_BASE_URL}/api/auth/discord/login` : '/server-management.html';
            const userProfileUrl = isLogin ? `${API_BASE_URL}/api/auth/discord/login` : '/profile.html';

            mainContent.innerHTML = `
                <div class="text-center pt-8 md:pt-12">
                    <h2 class="text-4xl font-bold mb-4 text-white">Welcome to the Ulti-Bot Network</h2>
                    <p class="text-xl mb-8 text-gray-300">Discover, manage, and engage with Discord communities like never before.</p>
                </div>
                <!-- This container will now be a row on medium screens and up, and will stretch its children to fill the vertical space -->
                <div class="flex-grow flex flex-col md:flex-row justify-center items-stretch space-y-6 md:space-y-0 md:space-x-6 pb-8 md:pb-12">
                    <a href="${serverSearchUrl}" class="bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg text-lg transition duration-300 ease-in-out transform hover:scale-105 flex-1 flex items-center justify-center text-3xl">
                        Server Search
                    </a>
                    <a href="${serverManagementUrl}" class="bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg text-lg transition duration-300 ease-in-out transform hover:scale-105 flex-1 flex items-center justify-center text-3xl">
                        Server Management
                    </a>
                    <a href="${userProfileUrl}" class="bg-gray-700 hover:bg-gray-600 text-white font-bold rounded-lg text-lg transition duration-300 ease-in-out transform hover:scale-105 flex-1 flex items-center justify-center text-3xl">
                        User Profile
                    </a>
                </div>
            `;
        }

        function renderErrorState() {
            mainContent.innerHTML = `
                <div class="flex-grow flex items-center justify-center">
                    <div class="text-center">
                        <h2 class="text-4xl font-bold mb-4 text-red-500">Connection Error</h2>
                        <p class="text-xl text-gray-300">Could not connect to the Ulti-Bot services. Please try again later.</p>
                        <p class="text-sm mt-2 text-gray-500">Ensure the API URL is correct and the backend service is running.</p>
                    </div>
                </div>
            `;
        }

        // --- EVENT HANDLERS ---

        async function handleVerification() {
            const verifyButton = document.getElementById('verify-button');
            verifyButton.disabled = true;
            verifyButton.textContent = 'Redirecting...';

            try {
                // Call the backend to create a Stripe Identity session
                const response = await fetch(`${API_BASE_URL}/api/stripe/create-verification-session`, {
                    method: 'POST',
                    credentials: 'include' // Crucial for sending the session cookie
                });

                if (!response.ok) {
                    throw new Error('Failed to create verification session.');
                }

                const data = await response.json();
                
                // Redirect the user to the Stripe URL
                window.location.href = data.url;

            } catch (error) {
                console.error('Verification error:', error);
                verifyButton.disabled = false;
                verifyButton.textContent = 'Verify with Stripe';
                alert('Could not start verification. Please try again.');
            }
        }
    </script>
</body>
</html>
